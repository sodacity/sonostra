<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokyo Travel Utility</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Noto+Sans+JP:wght@700&display=swap');

        :root {
            --bg-color: #0d0d1a; /* Dark space blue */
            --purple-grad: linear-gradient(45deg, #5b247a, #1bcedf);
            --blue-grad: linear-gradient(45deg, #1bcedf, #3763c9);
            --money-grad: linear-gradient(45deg, #2ed573, #1e90ff);
            --notes-grad: linear-gradient(45deg, #feca57, #ff9f43);
        }

        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Montserrat', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(at 20% 25%, hsla(212,70%,40%,0.3) 0px, transparent 50%), 
                              radial-gradient(at 80% 75%, hsla(343,70%,45%,0.3) 0px, transparent 50%);
            overflow: hidden;
            color: white;
        }

        /* --- Glassmorphism Style --- */
        .glass {
            background: rgba(44, 44, 64, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        /* --- Screen Container --- */
        .screen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            transition: transform 0.6s ease-in-out, opacity 0.5s;
            transform: scale(0.9);
            opacity: 0;
            pointer-events: none;
        }
        
        .screen.active {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        
        /* --- General Input Styles --- */
        .input-area { width: 100%; max-width: 600px; text-align: center; }
        .message-input { width: 100%; min-height: 150px; font-size: 1.5rem; padding: 15px; border-radius: 20px; color: #fff; margin-bottom: 20px; box-sizing: border-box; resize: vertical; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(0,0,0,0.2); }
        .input-title { font-size: 1.5rem; margin-bottom: 15px; color: #aaa; }
        .button-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .action-btn { padding: 15px 25px; font-size: 1.1rem; font-weight: bold; color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 50px; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; margin-top: 10px; }
        #joel-input-screen .action-btn.text-btn { background: var(--purple-grad); }
        #joel-input-screen .action-btn.money-btn { background: var(--money-grad); }
        #joel-input-screen .action-btn.notes-btn { background: var(--notes-grad); }
        #responder-input-screen .action-btn { background: var(--blue-grad); }
        #responder-input-screen .action-btn.cancel-btn { background: #555; } /* Style for new cancel button */
        .action-btn:disabled { background: #555; cursor: not-allowed; }

        /* --- Display Screen Styles --- */
        .message-card { border-radius: 40px; display: flex; justify-content: center; align-items: center; padding: 40px; text-align: center; font-size: clamp(3rem, 12vw, 8rem); line-height: 1.3; font-weight: bold; cursor: pointer; }
        .message-card::after { content: ''; position: absolute; bottom: -19px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border: 20px solid transparent; border-top-color: rgba(44, 44, 64, 0.3); border-bottom: 0; }
        #message-card[data-displayed-lang="en"] #message-output { word-spacing: 0.15em; }
        #message-output span { display: inline-block; opacity: 0; animation: popInWord 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards, float 5s ease-in-out 0.7s infinite; }
        @keyframes popInWord { from { opacity: 0; transform: scale(0.3) translateY(50px) rotate(0deg); } to   { opacity: 1; transform: scale(1) translateY(0) rotate(0deg); } }
        @keyframes float { 0% { transform: translateY(0px) rotate(0deg); } 25% { transform: translateY(-6px) rotate(-2deg); } 75% { transform: translateY(6px) rotate(2deg); } 100% { transform: translateY(0px) rotate(0deg); } }

        /* --- Weather Widget --- */
        #weather-widget { position: absolute; top: 20px; left: 20px; padding: 8px 15px; border-radius: 15px; font-size: 1rem; font-weight: bold; display: flex; align-items: center; gap: 10px; z-index: 10; }

        /* --- Modal Styles --- */
        .modal-overlay { background: rgba(0,0,0,0.5); }
        .modal-content { border-radius: 20px; width: 90%; max-width: 400px; text-align: center; padding: 30px; display: flex; flex-direction: column; max-height: 80vh; }
        .modal-content h2 { margin-top: 0; }
        .modal-close-btn { margin-top: 20px; background: rgba(0,0,0,0.3); }
        
        /* Yen Calc Modal */
        #yen-input { width: 100%; font-size: 2rem; text-align: center; border: none; border-bottom: 2px solid; border-image: var(--money-grad) 1; background: transparent; color: white; padding: 10px; box-sizing: border-box; }
        #yen-input:focus { outline: none; }
        #usd-output { font-size: 2.5rem; font-weight: bold; margin-top: 20px; color: #2ed573; }
        
        /* Tap Translate Modal */
        #translation-popup-content { font-size: 1.8rem; font-weight: bold; min-height: 50px; }
        
        /* Notes Modal */
        #notes-list { flex-grow: 1; overflow-y: auto; list-style: none; padding: 0; margin: 20px 0; text-align: left; }
        .note-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 10px 15px; border-radius: 10px; margin-bottom: 10px; font-size: 1.1rem; }
        .note-item button { background: none; border: none; color: #ff6b6b; font-size: 1.5rem; cursor: pointer; }
        #new-note-input { width: 100%; padding: 10px; font-size: 1.1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: white; margin-top: 10px; }

        /* --- Controls --- */
        .controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 100; }
        .control-btn { width: 60px; height: 60px; background: rgba(40, 40, 40, 0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; cursor: pointer; color: white; font-size: 24px; display: flex; justify-content: center; align-items: center; transition: all 0.2s ease; backdrop-filter: blur(5px); }
        .control-btn:hover { transform: scale(1.1); background: rgba(40, 40, 40, 0.5); }
        .top-right-controls { position: absolute; top: 20px; right: 20px; z-index: 10; }

    </style>
</head>
<body>

    <!-- Joel's Input Screen -->
    <div id="joel-input-screen" class="screen active">
        <div id="weather-widget" class="glass">Loading...</div>
        <div class="top-right-controls">
            <button id="home-fullscreen-btn" class="control-btn" title="Fullscreen">‚õ∂</button>
        </div>
        <div class="input-area">
            <h2 class="input-title">Your Message</h2>
            <textarea id="joel-message-input" class="message-input"></textarea>
            <div class="button-group">
                <button id="joel-submit-en" class="action-btn text-btn">Show (EN)</button>
                <button id="joel-submit-ja" class="action-btn text-btn">Translate (JA)</button>
                <button id="open-calculator-btn" class="action-btn money-btn">¬• Yen Calc</button>
                <button id="open-notes-btn" class="action-btn notes-btn">üìù Phrases/Notes</button>
            </div>
        </div>
    </div>

    <!-- Responder's Input Screen -->
    <div id="responder-input-screen" class="screen">
        <div class="input-area">
            <h2 class="input-title">Their Reply</h2>
            <textarea id="responder-message-input" class="message-input"></textarea>
            <div class="button-group">
                <button id="responder-submit-en" class="action-btn">Reply (EN)</button>
                <button id="responder-submit-ja" class="action-btn">Reply (JA)</button>
                <!-- NEW back button -->
                <button id="responder-cancel-btn" class="action-btn cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Text Display Screen -->
    <div id="display-screen" class="screen">
        <div id="message-card" class="message-card glass" data-displayed-text="" data-displayed-lang="">
            <div id="message-output"></div>
        </div>
        <div class="controls">
            <button id="display-fullscreen-btn" class="control-btn" title="Fullscreen">‚õ∂</button>
            <button id="reply-btn" class="control-btn" title="Let them reply">üîÑ</button>
            <button id="display-back-btn" class="control-btn" title="New Message">‚úé</button>
        </div>
    </div>
    
    <!-- Yen Calculator Modal -->
    <div id="calculator-modal" class="screen modal-overlay">
        <div class="modal-content glass">
            <h2>Yen to USD</h2>
            <input type="number" id="yen-input" placeholder="Enter Yen" inputmode="decimal">
            <div id="usd-output">$0.00</div>
            <button id="close-calculator-btn" class="action-btn modal-close-btn">Close</button>
        </div>
    </div>

    <!-- Tap-to-Translate Modal -->
    <div id="translation-popup" class="screen modal-overlay">
        <div class="modal-content glass">
            <h2>Translation</h2>
            <div id="translation-popup-content">Translating...</div>
            <button id="close-translation-popup-btn" class="action-btn modal-close-btn">Close</button>
        </div>
    </div>
    
    <!-- Phrases/Notes Modal -->
    <div id="notes-modal" class="screen modal-overlay">
        <div class="modal-content glass">
            <h2>Phrases & Notes</h2>
            <ul id="notes-list"></ul>
            <input type="text" id="new-note-input" placeholder="Add a new note...">
            <button id="close-notes-btn" class="action-btn modal-close-btn">Close</button>
        </div>
    </div>

    <script>
        const screens = {
            joelInput: document.getElementById('joel-input-screen'),
            responderInput: document.getElementById('responder-input-screen'),
            display: document.getElementById('display-screen'),
            calculator: document.getElementById('calculator-modal'),
            translationPopup: document.getElementById('translation-popup'),
            notes: document.getElementById('notes-modal')
        };
        let jpyToUsdRate = 0.0067; // Default rate, will be updated by API

        // --- Navigation ---
        function navigateTo(screenName) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[screenName].classList.add('active');
        }

        // --- API Fetching on Load ---
        async function fetchInitialData() {
            // Fetch Weather
            try {
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&current=temperature_2m,weather_code&temperature_unit=fahrenheit');
                const data = await response.json();
                const tempF = Math.round(data.current.temperature_2m);
                const tempC = Math.round((tempF - 32) * 5 / 9);
                const weatherCode = data.current.weather_code;
                const weatherEmojis = { 0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖÔ∏è', 3: '‚òÅÔ∏è', 45: 'üå´Ô∏è', 48: 'üå´Ô∏è', 51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üå¶Ô∏è', 61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è', 80: 'üåßÔ∏è', 81: 'üåßÔ∏è', 82: 'üåßÔ∏è', 95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è' };
                const emoji = weatherEmojis[weatherCode] || 'üåè';
                document.getElementById('weather-widget').innerHTML = `${emoji} ${tempF}¬∞F (${tempC}¬∞C)`;
            } catch (error) { console.error("Weather API Error:", error); document.getElementById('weather-widget').textContent = 'Weather unavailable'; }

            // Fetch Exchange Rate
            try {
                const rateResponse = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const rateData = await rateResponse.json();
                jpyToUsdRate = rateData.rates.USD;
            } catch (error) { console.error("Exchange Rate API Error:", error); }
        }

        // --- Yen Calculator ---
        const yenInput = document.getElementById('yen-input');
        document.getElementById('open-calculator-btn').addEventListener('click', () => { navigateTo('calculator'); yenInput.focus(); });
        document.getElementById('close-calculator-btn').addEventListener('click', () => navigateTo('joelInput'));
        yenInput.addEventListener('input', () => {
            const yenAmount = parseFloat(yenInput.value) || 0;
            const usdAmount = yenAmount * jpyToUsdRate;
            document.getElementById('usd-output').textContent = `$${usdAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        });

        // --- Tap-to-Translate ---
        const messageCard = document.getElementById('message-card');
        messageCard.addEventListener('click', async () => {
            const displayedText = messageCard.dataset.displayedText;
            const displayedLang = messageCard.dataset.displayedLang;
            if (!displayedText) return;
            navigateTo('translationPopup');
            document.getElementById('translation-popup-content').textContent = 'Translating...';
            const targetLang = displayedLang === 'en' ? 'ja' : 'en';
            const langPair = `${displayedLang}|${targetLang}`;
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(displayedText)}&langpair=${langPair}`);
                const data = await response.json();
                document.getElementById('translation-popup-content').textContent = data.responseData?.translatedText || "Could not translate.";
            } catch (error) { document.getElementById('translation-popup-content').textContent = "Translation failed."; }
        });
        document.getElementById('close-translation-popup-btn').addEventListener('click', () => navigateTo('display'));

        // --- Notes Logic ---
        const notesList = document.getElementById('notes-list');
        const newNoteInput = document.getElementById('new-note-input');
        let notes = JSON.parse(localStorage.getItem('travelNotes')) || [];

        function saveNotes() {
            localStorage.setItem('travelNotes', JSON.stringify(notes));
        }

        function renderNotes() {
            notesList.innerHTML = '';
            notes.forEach((note, index) => {
                const li = document.createElement('li');
                li.className = 'note-item';
                li.innerHTML = `<span>${note}</span><button data-index="${index}">√ó</button>`;
                notesList.appendChild(li);
            });
        }

        document.getElementById('open-notes-btn').addEventListener('click', () => {
            renderNotes();
            navigateTo('notes');
        });
        document.getElementById('close-notes-btn').addEventListener('click', () => navigateTo('joelInput'));

        newNoteInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && newNoteInput.value.trim() !== '') {
                notes.push(newNoteInput.value.trim());
                newNoteInput.value = '';
                saveNotes();
                renderNotes();
            }
        });
        
        notesList.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const index = e.target.dataset.index;
                notes.splice(index, 1);
                saveNotes();
                renderNotes();
            }
        });

        // --- Text Communicator Core Logic ---
        async function translateAndShow(text, langPair, isJapaneseOutput) {
            const button = event.target;
            button.disabled = true; button.textContent = '...';
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${langPair}`);
                const data = await response.json();
                displayMessage(data.responseData?.translatedText || "Translation Error", isJapaneseOutput);
            } catch (error) { displayMessage("Network Error", false); } 
            finally { button.disabled = false; button.textContent = event.target.id.includes('ja') ? 'Translate (JA)' : 'Show (EN)'; }
        }

        function displayMessage(message, isJapanese = false) {
            const messageOutput = document.getElementById('message-output');
            messageOutput.innerHTML = '';
            const parts = isJapanese ? message.split('') : message.split(/(\s+)/);
            parts.forEach((part, index) => {
                if (part.trim() !== '' || (isJapanese && part.trim() === '')) {
                    const span = document.createElement('span');
                    span.textContent = part;
                    span.style.animationDelay = `${index * 0.08}s`;
                    messageOutput.appendChild(span);
                } else {
                    messageOutput.appendChild(document.createTextNode(part));
                }
            });
            messageCard.dataset.displayedText = message;
            messageCard.dataset.displayedLang = isJapanese ? 'ja' : 'en';
            navigateTo('display');
        }

        // --- Event Listeners for Buttons ---
        document.getElementById('joel-submit-en').addEventListener('click', () => { const text = document.getElementById('joel-message-input').value; if (text.trim()) displayMessage(text, false); });
        document.getElementById('joel-submit-ja').addEventListener('click', () => { const text = document.getElementById('joel-message-input').value; if (text.trim()) translateAndShow(text, 'en|ja', true); });
        document.getElementById('responder-submit-en').addEventListener('click', () => { const text = document.getElementById('responder-message-input').value; if (text.trim()) translateAndShow(text, 'ja|en', false); });
        document.getElementById('responder-submit-ja').addEventListener('click', () => { const text = document.getElementById('responder-message-input').value; if (text.trim()) displayMessage(text, true); });
        document.getElementById('responder-cancel-btn').addEventListener('click', () => navigateTo('joelInput')); // Added listener for new button
        document.getElementById('reply-btn').addEventListener('click', () => navigateTo('responderInput'));
        document.getElementById('display-back-btn').addEventListener('click', () => navigateTo('joelInput'));
        
        function toggleFullscreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(err => console.error(err)); } else if (document.exitFullscreen) { document.exitFullscreen(); } }
        document.getElementById('home-fullscreen-btn').addEventListener('click', toggleFullscreen);
        document.getElementById('display-fullscreen-btn').addEventListener('click', toggleFullscreen);

        // --- Run on start ---
        fetchInitialData();
    </script>
</body>
</html>
